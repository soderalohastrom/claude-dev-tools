#!/bin/bash
# Claude Dev Tools - Installation Script
# Dependency analysis and large file tools for Claude Code

set -eo pipefail

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”§ Claude Dev Tools Installation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

GITHUB_REPO="soderalohastrom/claude-dev-tools"
GITHUB_BRANCH="main"
INSTALL_DIR="${PWD}"

# Detect local vs remote install
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" 2>/dev/null && pwd || echo "")"
INSTALL_MODE="remote"
SOURCE_DIR=""

if [ -n "$SCRIPT_DIR" ] && [ -f "$SCRIPT_DIR/manifest.json" ]; then
  INSTALL_MODE="local"
  SOURCE_DIR="$SCRIPT_DIR"
  echo "ğŸ“¦ Local installation from: $SOURCE_DIR"
else
  echo "ğŸŒ Remote installation from GitHub"
fi
echo ""

# Check for Go
GO_AVAILABLE=false
if command -v go &>/dev/null; then
  GO_VERSION=$(go version | grep -oE 'go[0-9]+\.[0-9]+' | head -1)
  echo "âœ“ Go found: $GO_VERSION"
  GO_AVAILABLE=true
else
  echo "âš  Go not found - Go tools will not be built"
  echo "  Install from: https://go.dev/dl/"
fi
echo ""

# Create directories
echo "Creating .claude directories..."
mkdir -p "$INSTALL_DIR/.claude/tools/query-deps"
mkdir -p "$INSTALL_DIR/.claude/tools/impact-analysis"
mkdir -p "$INSTALL_DIR/.claude/tools/find-circular"
mkdir -p "$INSTALL_DIR/.claude/tools/find-dead-code"
mkdir -p "$INSTALL_DIR/.claude/lib"
mkdir -p "$INSTALL_DIR/.claude/scripts"
mkdir -p "$INSTALL_DIR/.claude/hooks"
mkdir -p "$INSTALL_DIR/.claude/bin"
mkdir -p "$INSTALL_DIR/.claude/commands"
echo "âœ“ Directories created"
echo ""

# Download function for remote installs
download_file() {
  local path="$1"
  local dest="$2"
  curl -fsSL "https://raw.githubusercontent.com/$GITHUB_REPO/$GITHUB_BRANCH/$path" -o "$dest"
}

# Install lib
echo "Installing lib..."
if [ "$INSTALL_MODE" = "local" ]; then
  cp "$SOURCE_DIR/lib/toon-parser.sh" "$INSTALL_DIR/.claude/lib/"
else
  download_file "lib/toon-parser.sh" "$INSTALL_DIR/.claude/lib/toon-parser.sh"
fi
chmod +x "$INSTALL_DIR/.claude/lib/toon-parser.sh"
echo "  âœ“ toon-parser.sh"

# Install shell tools
echo ""
echo "Installing tools..."
for tool in query-deps impact-analysis find-circular find-dead-code; do
  if [ "$INSTALL_MODE" = "local" ]; then
    cp "$SOURCE_DIR/tools/$tool/$tool.sh" "$INSTALL_DIR/.claude/tools/$tool/"
  else
    download_file "tools/$tool/$tool.sh" "$INSTALL_DIR/.claude/tools/$tool/$tool.sh"
  fi
  chmod +x "$INSTALL_DIR/.claude/tools/$tool/$tool.sh"
  echo "  âœ“ $tool"
done

# Install scripts
echo ""
echo "Installing scripts..."
for script in show-deps-tree.sh verify-install.sh; do
  if [ "$INSTALL_MODE" = "local" ]; then
    cp "$SOURCE_DIR/scripts/$script" "$INSTALL_DIR/.claude/scripts/"
  else
    download_file "scripts/$script" "$INSTALL_DIR/.claude/scripts/$script"
  fi
  chmod +x "$INSTALL_DIR/.claude/scripts/$script"
  echo "  âœ“ $script"
done

# Install hooks
echo ""
echo "Installing hooks..."
if [ "$INSTALL_MODE" = "local" ]; then
  cp "$SOURCE_DIR/hooks/large-file-guard.sh" "$INSTALL_DIR/.claude/hooks/"
else
  download_file "hooks/large-file-guard.sh" "$INSTALL_DIR/.claude/hooks/large-file-guard.sh"
fi
chmod +x "$INSTALL_DIR/.claude/hooks/large-file-guard.sh"
echo "  âœ“ large-file-guard.sh"

# Install slash commands
echo ""
echo "Installing slash commands..."
for cmd in deps impact circular deadcode deps-tree large-file scan-deps verify-tools; do
  if [ "$INSTALL_MODE" = "local" ]; then
    cp "$SOURCE_DIR/commands/$cmd.md" "$INSTALL_DIR/.claude/commands/"
  else
    download_file "commands/$cmd.md" "$INSTALL_DIR/.claude/commands/$cmd.md"
  fi
  echo "  âœ“ /$cmd"
done

# Build Go tools
if [ "$GO_AVAILABLE" = true ]; then
  echo ""
  echo "Building Go tools..."

  if [ "$INSTALL_MODE" = "local" ]; then
    # Local build
    echo "  Building dependency-scanner..."
    if (cd "$SOURCE_DIR/tools/dependency-scanner" && go build -o "$INSTALL_DIR/.claude/bin/dependency-scanner" .) 2>/dev/null; then
      echo "  âœ“ dependency-scanner"
    else
      echo "  âš  dependency-scanner build failed"
    fi

    echo "  Building progressive-reader..."
    if (cd "$SOURCE_DIR/tools/progressive-reader" && go build -o "$INSTALL_DIR/.claude/bin/progressive-reader" ./cmd) 2>/dev/null; then
      echo "  âœ“ progressive-reader"
    else
      echo "  âš  progressive-reader build failed"
    fi
  else
    # Remote build - clone to temp dir
    echo "  Cloning repository for Go build..."
    TEMP_DIR=$(mktemp -d)
    if git clone --depth 1 "https://github.com/$GITHUB_REPO.git" "$TEMP_DIR" 2>/dev/null; then
      echo "  Building dependency-scanner..."
      if (cd "$TEMP_DIR/tools/dependency-scanner" && go build -o "$INSTALL_DIR/.claude/bin/dependency-scanner" .) 2>/dev/null; then
        echo "  âœ“ dependency-scanner"
      else
        echo "  âš  dependency-scanner build failed"
      fi

      echo "  Building progressive-reader..."
      if (cd "$TEMP_DIR/tools/progressive-reader" && go build -o "$INSTALL_DIR/.claude/bin/progressive-reader" ./cmd) 2>/dev/null; then
        echo "  âœ“ progressive-reader"
      else
        echo "  âš  progressive-reader build failed"
      fi

      rm -rf "$TEMP_DIR"
    else
      echo "  âš  Could not clone repository for Go build"
    fi
  fi
fi

# Configure settings.local.json
echo ""
echo "Configuring hooks..."
if [ ! -f "$INSTALL_DIR/.claude/settings.local.json" ]; then
  cat > "$INSTALL_DIR/.claude/settings.local.json" << 'SETTINGS'
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash .claude/hooks/large-file-guard.sh"
          }
        ]
      }
    ]
  }
}
SETTINGS
  echo "âœ“ Created settings.local.json"
else
  echo "âš  settings.local.json exists"
  echo "  Add this hook manually if needed:"
  echo '  "PreToolUse": [{"matcher": "*", "hooks": [{"type": "command", "command": "bash .claude/hooks/large-file-guard.sh"}]}]'
fi

# Create/update CLAUDE.md
echo ""
CLAUDE_CONTENT='# Claude Dev Tools

Dependency analysis and large file tools.

## Slash Commands

| Command | Description |
|---------|-------------|
| `/deps <file>` | What imports this file? |
| `/impact <file>` | What breaks if I change this? |
| `/circular` | Find circular dependencies |
| `/deadcode` | Find unused files |
| `/deps-tree <file>` | Visualize dependency tree |
| `/large-file <file>` | Read large file progressively |
| `/scan-deps` | Rebuild dependency graph |
| `/verify-tools` | Verify installation |

## Large Files (>50KB)

The PreToolUse hook blocks Read on files over 50KB. Use `/large-file` or:

```bash
.claude/bin/progressive-reader --path <file> --list    # See structure
.claude/bin/progressive-reader --path <file> --chunk N  # Read chunk
```

## Rebuild Dependency Graph

```bash
.claude/bin/dependency-scanner --path . --output .claude/dep-graph.toon
```'

if [ ! -f "$INSTALL_DIR/CLAUDE.md" ]; then
  echo "$CLAUDE_CONTENT" > "$INSTALL_DIR/CLAUDE.md"
  echo "âœ“ Created CLAUDE.md"
elif ! grep -q "Claude Dev Tools" "$INSTALL_DIR/CLAUDE.md" 2>/dev/null; then
  echo "" >> "$INSTALL_DIR/CLAUDE.md"
  echo "---" >> "$INSTALL_DIR/CLAUDE.md"
  echo "" >> "$INSTALL_DIR/CLAUDE.md"
  echo "$CLAUDE_CONTENT" >> "$INSTALL_DIR/CLAUDE.md"
  echo "âœ“ Appended to CLAUDE.md"
else
  echo "âœ“ CLAUDE.md already has Claude Dev Tools section"
fi

# Update .gitignore
echo ""
echo "Updating .gitignore..."
touch "$INSTALL_DIR/.gitignore"
for entry in ".claude/bin/" ".claude/dep-graph.toon"; do
  if ! grep -q "^${entry}$" "$INSTALL_DIR/.gitignore" 2>/dev/null; then
    echo "$entry" >> "$INSTALL_DIR/.gitignore"
  fi
done
echo "âœ“ .gitignore updated"

# Build initial dep graph
if [ -f "$INSTALL_DIR/.claude/bin/dependency-scanner" ]; then
  echo ""
  echo "Building dependency graph..."
  if "$INSTALL_DIR/.claude/bin/dependency-scanner" --path "$INSTALL_DIR" --output "$INSTALL_DIR/.claude/dep-graph.toon" 2>/dev/null; then
    echo "âœ“ Dependency graph built"
  else
    echo "âš  Could not build dependency graph (run manually later)"
  fi
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Claude Dev Tools Installed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Slash commands available:"
echo "  /deps <file>       - Query file dependencies"
echo "  /impact <file>     - Impact analysis"
echo "  /circular          - Find circular dependencies"
echo "  /deadcode          - Find unused files"
echo "  /deps-tree <file>  - Visualize dependency tree"
echo "  /large-file <file> - Read large files progressively"
echo "  /scan-deps         - Rebuild dependency graph"
echo "  /verify-tools      - Verify installation"
echo ""
echo "Run /verify-tools to confirm everything is working."
echo ""
